<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Friends Map v2</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body, html { height: 100%; margin: 0; padding: 0; background-color: #0f172a; overflow: hidden; }
        #map { 
            position: absolute; top: 0; left: 0; right: 0; bottom: 0; 
            width: 100%; height: 100%; background: #0b0f1a; z-index: 1;
        }
        .glass { background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .screen { position: fixed; inset: 0; z-index: 2000; background: #0f172a; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: all 0.3s; }
        .hidden { display: none !important; }
        .ui-overlay { position: absolute; z-index: 1000; pointer-events: none; }
        .ui-overlay button, .ui-overlay input { pointer-events: auto; }
        
        /* Стили маркеров */
        .friend-label {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #f97316;
            border-radius: 4px;
            padding: 2px 6px;
            font-size: 12px;
            font-weight: bold;
            color: #c2410c;
            white-space: nowrap;
            margin-top: -40px; /* Поднимаем над маркером */
            margin-left: -10px;
        }
    </style>
</head>
<body>

    <div id="loginScreen" class="screen">
        <div class="w-full max-w-xs text-center p-4">
            <h1 class="text-3xl font-bold text-white mb-6">Friends Map</h1>
            <input type="text" id="usernameInput" placeholder="Ваш ник" class="w-full bg-white/10 border border-white/20 rounded-xl px-4 py-3 text-white mb-4 outline-none focus:border-blue-500">
            <button onclick="registerUser()" id="loginBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl transition">Войти</button>
        </div>
    </div>

    <div id="permScreen" class="screen hidden">
        <div class="text-center p-6">
            <div class="text-blue-400 mb-4"><i data-lucide="navigation" class="w-12 h-12 mx-auto"></i></div>
            <h2 class="text-white text-xl font-bold mb-4">Включите GPS</h2>
            <p class="text-gray-400 mb-6 text-sm">Чтобы друзья видели вас на карте</p>
            <button onclick="requestGeo()" class="bg-blue-600 text-white px-8 py-3 rounded-xl font-bold">Разрешить</button>
        </div>
    </div>

    <div id="friendsModal" class="screen hidden bg-black/80 backdrop-blur-md">
        <div class="w-full max-w-sm bg-[#1e293b] rounded-2xl p-6 border border-white/10 relative shadow-2xl">
            <button onclick="toggleFriends()" class="absolute top-4 right-4 text-gray-400 hover:text-white">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
            
            <h2 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
                <i data-lucide="users" class="w-5 h-5 text-orange-500"></i> Друзья
            </h2>

            <div class="bg-black/30 p-3 rounded-lg mb-6 border border-white/5">
                <p class="text-xs text-gray-400 mb-1">Ваш ID (нажмите, чтобы скопировать):</p>
                <button onclick="copyMyId()" class="flex items-center justify-between w-full text-left">
                    <span id="myUidDisplay" class="text-green-400 font-mono text-sm truncate mr-2">...</span>
                    <i data-lucide="copy" class="w-4 h-4 text-gray-500"></i>
                </button>
            </div>

            <div class="flex gap-2 mb-6">
                <input type="text" id="friendIdInput" placeholder="Вставьте ID друга" class="flex-1 bg-white/10 border border-white/20 rounded-lg px-3 py-2 text-white text-sm outline-none">
                <button onclick="addFriend()" class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-lg font-bold text-sm">
                    <i data-lucide="plus" class="w-5 h-5"></i>
                </button>
            </div>

            <div class="border-t border-white/10 pt-4">
                <h3 class="text-sm font-bold text-gray-400 mb-2">Ваши друзья:</h3>
                <div id="friendsList" class="max-h-40 overflow-y-auto space-y-2 text-sm text-white">
                    <p class="text-gray-500 italic text-xs">Список пуст...</p>
                </div>
            </div>
        </div>
    </div>

    <div id="map"></div>

    <div class="ui-overlay top-4 left-4">
        <div class="glass px-4 py-2 rounded-full flex items-center gap-2 shadow-lg">
            <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
            <span class="text-white text-xs font-bold" id="myUsernameDisplay">Загрузка...</span>
        </div>
    </div>

    <div class="ui-overlay top-4 right-4 flex flex-col gap-3">
        <button onclick="centerMap()" class="glass w-12 h-12 rounded-xl flex items-center justify-center text-white shadow-lg active:scale-95 transition">
            <i data-lucide="crosshair" class="w-6 h-6"></i>
        </button>
        <button onclick="toggleFriends()" class="glass w-12 h-12 rounded-xl flex items-center justify-center text-orange-400 shadow-lg active:scale-95 transition">
            <i data-lucide="users" class="w-6 h-6"></i>
        </button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc, arrayUnion, getDoc, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA2Sfd1x9cbXM0IiuVlHOildej1qatsVjk",
            authDomain: "project-9014284950271439961.firebaseapp.com",
            projectId: "project-9014284950271439961",
            storageBucket: "project-9014284950271439961.firebasestorage.app",
            messagingSenderId: "317951575710",
            appId: "1:317951575710:web:68139dd2368148c7491d8f"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let map = null;
        let myMarker = null;
        let friendsMarkers = {}; // Объект для хранения маркеров друзей: { uid: marker }
        let myFriendsUids = []; // Массив UID друзей

        // --- 1. АВТОРИЗАЦИЯ ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('myUidDisplay').innerText = user.uid;
                checkUser();
            } else {
                signInAnonymously(auth);
            }
        });

        // Проверка регистрации и запуск слушателей
        async function checkUser() {
            const userRef = doc(db, 'users', currentUser.uid);
            
            // Слушаем СВОЙ профиль (чтобы получить список друзей)
            onSnapshot(userRef, (snap) => {
                if (snap.exists()) {
                    const data = snap.data();
                    document.getElementById('myUsernameDisplay').innerText = data.username;
                    document.getElementById('loginScreen').classList.add('hidden');
                    
                    // Обновляем список друзей в памяти и в UI
                    myFriendsUids = data.friends || [];
                    renderFriendsList(myFriendsUids);
                    
                    if (!map) document.getElementById('permScreen').classList.remove('hidden');
                } else {
                    document.getElementById('loginScreen').classList.remove('hidden');
                }
            });

            // Слушаем ВСЕХ пользователей (чтобы отображать друзей на карте)
            // Примечание: В реальном большом приложении лучше использовать where('uid', 'in', ...), но для прототипа так проще
            onSnapshot(collection(db, "users"), (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    const data = change.doc.data();
                    const uid = change.doc.id;

                    if (uid === currentUser.uid) return; // Пропускаем себя

                    if (change.type === "added" || change.type === "modified") {
                        updateFriendMarker(uid, data);
                    }
                    if (change.type === "removed") {
                        removeFriendMarker(uid);
                    }
                });
                
                // Проходимся по существующим маркерам и удаляем тех, кто перестал быть другом
                Object.keys(friendsMarkers).forEach(uid => {
                    if (!myFriendsUids.includes(uid)) {
                        removeFriendMarker(uid);
                    }
                });
            });
        }

        window.registerUser = async () => {
            const name = document.getElementById('usernameInput').value.trim();
            if (name.length < 2) return alert("Имя слишком короткое");
            
            await setDoc(doc(db, 'users', currentUser.uid), {
                username: name,
                uid: currentUser.uid,
                coords: null,
                friends: [] // Инициализируем пустой массив друзей
            }, { merge: true });
        };

        // --- 2. ЛОГИКА ДРУЗЕЙ ---
        
        // Открыть/закрыть модальное окно
        window.toggleFriends = () => {
            const el = document.getElementById('friendsModal');
            el.classList.toggle('hidden');
            if(!el.classList.contains('hidden')) {
                // Перерисовать список при открытии на всякий случай
                renderFriendsList(myFriendsUids);
            }
        };

        // Копировать мой UID
        window.copyMyId = () => {
            navigator.clipboard.writeText(currentUser.uid).then(() => {
                alert("ID скопирован! Отправьте его другу.");
            });
        };

        // Добавить друга
        window.addFriend = async () => {
            const friendUid = document.getElementById('friendIdInput').value.trim();
            if (!friendUid) return;
            if (friendUid === currentUser.uid) return alert("Нельзя добавить самого себя!");

            // Проверяем, существует ли такой юзер
            const friendDoc = await getDoc(doc(db, 'users', friendUid));
            if (!friendDoc.exists()) {
                alert("Пользователь с таким ID не найден.");
                return;
            }

            // Добавляем в массив friends
            await updateDoc(doc(db, 'users', currentUser.uid), {
                friends: arrayUnion(friendUid)
            });
            
            document.getElementById('friendIdInput').value = "";
            alert(`Друг ${friendDoc.data().username} добавлен!`);
        };

        // Рендер списка друзей в модальном окне
        async function renderFriendsList(ids) {
            const container = document.getElementById('friendsList');
            if (ids.length === 0) {
                container.innerHTML = '<p class="text-gray-500 italic text-xs">Список пуст...</p>';
                return;
            }
            
            // Чтобы показать имена, нам нужно знать данные друзей. 
            // В рамках слушателя "ВСЕХ" пользователей у нас эти данные могут быть, 
            // но для простоты списка покажем просто ID или "Загрузка..."
            // Лучше всего имена брать из кэша карты или подгружать.
            // Для упрощения сделаем простой список.
            
            container.innerHTML = ids.map(id => `
                <div class="flex justify-between items-center bg-white/5 p-2 rounded">
                    <span class="truncate w-40 font-mono text-xs">${id.slice(0,8)}...</span>
                    <span class="text-green-500 text-xs">OK</span>
                </div>
            `).join('');
        }

        // --- 3. КАРТА И МАРКЕРЫ ---

        window.requestGeo = () => {
            navigator.geolocation.getCurrentPosition((pos) => {
                document.getElementById('permScreen').classList.add('hidden');
                initMap(pos.coords.latitude, pos.coords.longitude);
            }, () => alert("Нужен доступ к GPS"), { enableHighAccuracy: true });
        };

        function initMap(lat, lng) {
            map = L.map('map', { zoomControl: false, attributionControl: false }).setView([lat, lng], 15);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                maxZoom: 19
            }).addTo(map); // Используем темную карту, она круче выглядит

            setTimeout(() => { map.invalidateSize(); }, 300);

            // Следим за собой
            navigator.geolocation.watchPosition(async (pos) => {
                const { latitude, longitude } = pos.coords;
                
                // Кастомный маркер для себя (Синий круг)
                const myIcon = L.divIcon({
                    className: 'custom-div-icon',
                    html: `<div style="background-color:#3b82f6; width: 16px; height: 16px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 10px #3b82f6;"></div>`,
                    iconSize: [16, 16],
                    iconAnchor: [8, 8]
                });

                if (!myMarker) {
                    myMarker = L.marker([latitude, longitude], {icon: myIcon}).addTo(map);
                } else {
                    myMarker.setLatLng([latitude, longitude]);
                }

                await updateDoc(doc(db, 'users', currentUser.uid), {
                    coords: { lat: latitude, lng: longitude }
                });
            }, null, { enableHighAccuracy: true });

            lucide.createIcons();
        }

        // Обновление маркера друга
        function updateFriendMarker(uid, data) {
            // Если этот юзер не мой друг - удаляем маркер (если был) и выходим
            if (!myFriendsUids.includes(uid)) {
                removeFriendMarker(uid);
                return;
            }

            // Если у друга нет координат - ничего не делаем
            if (!data.coords) return;

            const friendLat = data.coords.lat;
            const friendLng = data.coords.lng;
            const friendName = data.username || "Друг";

            // Иконка для друга (Оранжевая)
            const friendIcon = L.divIcon({
                className: 'friend-marker',
                html: `
                    <div style="background-color:#f97316; width: 14px; height: 14px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 8px #f97316;"></div>
                    <div class="friend-label">${friendName}</div>
                `,
                iconSize: [14, 14],
                iconAnchor: [7, 7]
            });

            if (friendsMarkers[uid]) {
                // Двигаем существующий
                friendsMarkers[uid].setLatLng([friendLat, friendLng]);
                friendsMarkers[uid].setIcon(friendIcon); // Обновляем имя если изменилось
            } else {
                // Создаем новый
                if(map) {
                    const marker = L.marker([friendLat, friendLng], { icon: friendIcon }).addTo(map);
                    friendsMarkers[uid] = marker;
                }
            }
        }

        function removeFriendMarker(uid) {
            if (friendsMarkers[uid]) {
                map.removeLayer(friendsMarkers[uid]);
                delete friendsMarkers[uid];
            }
        }

        window.centerMap = () => { if (myMarker) map.flyTo(myMarker.getLatLng(), 17); };
    </script>
</body>
</html>
