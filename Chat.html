<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MuzaffR Chat ¬∑ Telegram style + Gifts</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ========== –°–ë–†–û–° ========== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        /* ========== –ü–ï–†–ï–ú–ï–ù–ù–´–ï ========== */
        :root {
            --tg-bg: #e7ebf0;
            --tg-surface: #ffffff;
            --tg-text: #0f1822;
            --tg-text-secondary: #5e6f7e;
            --tg-border: #dae0e6;
            --tg-message-out: #e2f0ff;
            --tg-message-in: #ffffff;
            --tg-primary: #2A6B9C;
            --tg-online: #2ba50f;
            --tg-offline: #8e9aa6;
            --tg-shadow: 0 2px 4px rgba(0,0,0,0.06);
            --tg-shadow-lg: 0 8px 20px rgba(0,0,0,0.12);
            --tg-hover: rgba(0,0,0,0.04);
        }

        .dark-mode {
            --tg-bg: #0f1822;
            --tg-surface: #1e2a36;
            --tg-text: #eaeaea;
            --tg-text-secondary: #b0c4d9;
            --tg-border: #2b3b4a;
            --tg-message-out: #2b5278;
            --tg-message-in: #1e2a36;
            --tg-hover: rgba(255,255,255,0.04);
        }

        body {
            background: var(--tg-bg);
            color: var(--tg-text);
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s, color 0.2s;
            overflow: hidden;
        }

        #appContainer {
            width: 100%;
            max-width: 1400px;
            height: 100vh;
            display: flex;
            background: var(--tg-surface);
            box-shadow: var(--tg-shadow-lg);
            overflow: hidden;
        }

        /* ========== –ë–û–ö–û–í–ê–Ø –ü–ê–ù–ï–õ–¨ ========== */
        .sidebar {
            width: 360px;
            background: var(--tg-surface);
            border-right: 1px solid var(--tg-border);
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--tg-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .sidebar-header h2 {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--tg-primary);
        }

        .icon-btn {
            background: transparent;
            border: none;
            color: var(--tg-text-secondary);
            font-size: 1.2rem;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.2s;
        }

        .icon-btn:hover {
            background: var(--tg-hover);
        }

        .search-box {
            padding: 12px 20px;
            border-bottom: 1px solid var(--tg-border);
        }

        .search-box input {
            width: 100%;
            padding: 10px 16px;
            background: var(--tg-bg);
            border: none;
            border-radius: 30px;
            color: var(--tg-text);
            font-size: 0.95rem;
        }

        .user-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px 0;
        }

        .user-item {
            display: flex;
            align-items: center;
            padding: 10px 20px;
            cursor: pointer;
            transition: background 0.15s;
        }
        .user-item:hover { background: var(--tg-hover); }
        .user-item.active { background: rgba(42, 107, 156, 0.1); }

        .avatar {
            width: 54px;
            height: 54px;
            border-radius: 50%;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1.3rem;
            margin-right: 15px;
            flex-shrink: 0;
            position: relative;
            background: var(--tg-primary);
        }
        .avatar.online::after {
            content: '';
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: var(--tg-online);
            border: 2px solid var(--tg-surface);
        }

        .user-info { flex:1; min-width:0; }
        .user-row { display: flex; justify-content: space-between; margin-bottom:4px; }
        .user-name { font-weight:600; white-space: nowrap; overflow:hidden; text-overflow:ellipsis; }
        .time-badge { font-size:0.7rem; color:var(--tg-text-secondary); }
        .last-message { font-size:0.85rem; color:var(--tg-text-secondary); white-space: nowrap; overflow:hidden; text-overflow:ellipsis; }
        .unread-badge {
            background: var(--tg-primary);
            color: white;
            border-radius: 20px;
            padding: 2px 8px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-left: 8px;
        }

        /* ========== –ß–ê–¢ ========== */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--tg-surface);
        }

        .chat-header {
            padding: 12px 25px;
            border-bottom: 1px solid var(--tg-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .chat-header-left { display: flex; align-items: center; gap:15px; }
        .chat-header-avatar {
            width: 48px; height:48px; border-radius:50%;
            background: var(--tg-primary);
            color:white; display:flex; align-items:center; justify-content:center;
            font-weight:600; font-size:1.3rem; position:relative;
        }
        .chat-header-avatar.online::after {
            content:''; position:absolute; bottom:2px; right:2px;
            width:14px; height:14px; border-radius:50%; background:var(--tg-online);
            border:2px solid var(--tg-surface);
        }
        .chat-header-info h3 { font-size:1.2rem; font-weight:600; margin-bottom:4px; }
        .chat-header-info span { font-size:0.85rem; color:var(--tg-text-secondary); display:flex; align-items:center; gap:4px; }
        .chat-header-actions { display:flex; gap:10px; }

        .messages-container {
            flex: 1;
            padding: 20px 25px;
            overflow-y: auto;
            background: var(--tg-bg);
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .date-separator {
            text-align: center;
            margin: 15px 0;
        }
        .date-separator span {
            background: var(--tg-surface);
            padding: 4px 16px;
            border-radius: 30px;
            font-size: 0.75rem;
            color: var(--tg-text-secondary);
            box-shadow: var(--tg-shadow);
        }

        .message {
            max-width: 65%;
            padding: 10px 14px;
            border-radius: 18px;
            word-wrap: break-word;
            animation: fadeIn 0.2s;
            font-size: 0.95rem;
            box-shadow: var(--tg-shadow);
        }
        .message.out {
            background: var(--tg-message-out);
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }
        .message.in {
            background: var(--tg-message-in);
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }
        .message .reply-preview {
            border-left: 3px solid var(--tg-primary);
            padding-left: 10px;
            margin-bottom: 6px;
            font-size: 0.85rem;
            opacity: 0.8;
        }
        .message .attachments { margin-top:6px; }
        .message .attachments img { max-width:200px; border-radius:12px; cursor:pointer; }
        .file-attach {
            display: flex; align-items: center; gap:8px;
            background: var(--tg-surface); padding:8px 12px; border-radius:12px; margin-top:4px;
        }
        .message-footer {
            display: flex; align-items: center; justify-content: flex-end; gap:4px;
            margin-top:4px; font-size:0.65rem; color:var(--tg-text-secondary);
        }
        .double-check.read { color: var(--tg-primary); }

        /* –ü–æ–¥–∞—Ä–∫–∏ */
        .gift-message {
            text-align: center;
        }
        .gift-message img {
            max-width: 150px;
            border-radius: 15px;
            margin-bottom: 5px;
        }

        .typing-indicator {
            display: flex; align-items: center; gap:4px; padding:8px 16px;
            background: var(--tg-message-in); border-radius:18px; align-self:flex-start;
            box-shadow: var(--tg-shadow);
        }
        .typing-dots { display:flex; gap:3px; }
        .typing-dots span {
            width:6px; height:6px; background:var(--tg-text-secondary);
            border-radius:50%; animation: typing 1.4s infinite;
        }
        @keyframes typing { 0%,60%,100%{ opacity:0.3; } 30%{ opacity:1; } }

        /* –í–≤–æ–¥ */
        .input-area {
            padding: 15px 25px;
            border-top: 1px solid var(--tg-border);
            background: var(--tg-surface);
        }
        .reply-bar {
            background: var(--tg-bg); border-radius:12px; padding:8px 15px; margin-bottom:10px;
            display:flex; align-items:center; justify-content:space-between; font-size:0.9rem;
        }
        .reply-author { font-weight:600; color:var(--tg-primary); }
        .reply-cancel { cursor:pointer; color:var(--tg-text-secondary); }
        .attachment-previews { display:flex; flex-wrap:wrap; gap:8px; margin-bottom:10px; }
        .attach-preview-item {
            position:relative; width:70px; height:70px; border-radius:12px; overflow:hidden; background:var(--tg-bg);
        }
        .attach-preview-item img { width:100%; height:100%; object-fit:cover; }
        .attach-preview-item .remove {
            position:absolute; top:2px; right:2px; background:rgba(0,0,0,0.5); color:white;
            width:20px; height:20px; border-radius:50%; display:flex; align-items:center; justify-content:center;
            font-size:12px; cursor:pointer;
        }
        .message-input-wrapper {
            display:flex; align-items:flex-end; gap:8px; background:var(--tg-bg);
            border-radius:30px; padding:6px 8px 6px 18px;
        }
        .message-input-wrapper textarea {
            flex:1; background:transparent; border:none; padding:10px 0; max-height:120px;
            resize:none; color:var(--tg-text); font-size:0.95rem; outline:none;
        }
        .input-actions { display:flex; gap:4px; }

        /* –≠–º–æ–¥–∑–∏-–ø–∏–∫–µ—Ä –∏ –ø–∞–Ω–µ–ª—å –ø–æ–¥–∞—Ä–∫–æ–≤ */
        .emoji-picker, .gift-picker {
            position: absolute;
            bottom: 90px;
            right: 30px;
            width: 340px;
            background: var(--tg-surface);
            border-radius: 20px;
            box-shadow: var(--tg-shadow-lg);
            border: 1px solid var(--tg-border);
            display: none;
            flex-direction: column;
            z-index: 1000;
        }
        .emoji-picker.show, .gift-picker.show { display: flex; }
        .emoji-header {
            padding: 12px;
            border-bottom: 1px solid var(--tg-border);
            display: flex;
            justify-content: space-between;
        }
        .emoji-categories {
            display: flex; gap:8px; padding:8px 12px; border-bottom:1px solid var(--tg-border);
        }
        .emoji-cat { cursor:pointer; opacity:0.6; transition:0.2s; font-size:1.2rem; }
        .emoji-cat.active { opacity:1; }
        .emoji-grid {
            display: grid; grid-template-columns: repeat(8,1fr); gap:4px;
            padding:12px; max-height:200px; overflow-y:auto;
        }
        .emoji-item { font-size:1.5rem; text-align:center; padding:4px; cursor:pointer; border-radius:8px; }
        .emoji-item:hover { background:var(--tg-hover); }

        .gift-grid {
            display: grid; grid-template-columns: repeat(3,1fr); gap:12px; padding:15px; max-height:250px; overflow-y:auto;
        }
        .gift-item {
            text-align:center; cursor:pointer; border-radius:12px; padding:10px; transition:background 0.2s;
        }
        .gift-item:hover { background:var(--tg-hover); }
        .gift-item img { width:60px; height:60px; object-fit:contain; border-radius:10px; }
        .gift-item span { display:block; font-size:0.8rem; margin-top:5px; color:var(--tg-text-secondary); }

        /* –ú–æ–¥–∞–ª–∫–∏ */
        .modal {
            position:fixed; top:0; left:0; width:100%; height:100%;
            background:rgba(0,0,0,0.5); display:flex; align-items:center; justify-content:center;
            z-index:3000; opacity:0; pointer-events:none; transition:0.2s;
        }
        .modal.show { opacity:1; pointer-events:auto; }
        .modal-content {
            background:var(--tg-surface); border-radius:30px; width:400px; max-width:90%; padding:30px; text-align:center;
        }
        .modal-content .user-list { max-height:300px; overflow-y:auto; margin-top:20px; }

        /* –ê–¥–∞–ø—Ç–∞—Ü–∏—è */
        @media (max-width:800px) {
            .sidebar { position:absolute; left:-360px; top:0; bottom:0; z-index:100; transition:left 0.2s; box-shadow:var(--tg-shadow-lg); }
            .sidebar.mobile-show { left:0; }
            #menuBtn { display:block; }
        }
        #menuBtn { display:none; }

        .theme-toggle {
            position:fixed; bottom:20px; right:20px; width:50px; height:50px; border-radius:50%;
            background:var(--tg-surface); box-shadow:var(--tg-shadow-lg); border:1px solid var(--tg-border);
            display:flex; align-items:center; justify-content:center; cursor:pointer; z-index:1000;
        }

        .notification {
            position:fixed; top:20px; right:20px; background:var(--tg-surface);
            border-left:4px solid var(--tg-primary); border-radius:12px; padding:12px 20px;
            box-shadow:var(--tg-shadow-lg); z-index:4000; animation:slideIn 0.3s;
        }
        @keyframes slideIn { from { transform:translateX(100%); opacity:0; } to { transform:translateX(0); opacity:1; } }

        @keyframes fadeIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }
    </style>
</head>
<body>
    <!-- –ú–æ–¥–∞–ª–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ -->
    <div id="authModal" class="modal show">
        <div class="modal-content">
            <div style="font-size: 3rem; margin-bottom: 20px; color: var(--tg-primary);">üí¨</div>
            <h2 style="margin-bottom: 25px;">MuzaffR Chat</h2>
            <div id="authError" style="color: #e53935; margin-bottom: 15px; display: none;"></div>
            <input type="text" id="username" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" style="width: 100%; padding: 14px; border-radius: 30px; border: 1px solid var(--tg-border); background: var(--tg-bg); color: var(--tg-text); margin-bottom: 15px;">
            <input type="password" id="password" placeholder="–ü–∞—Ä–æ–ª—å" style="width: 100%; padding: 14px; border-radius: 30px; border: 1px solid var(--tg-border); background: var(--tg-bg); color: var(--tg-text); margin-bottom: 20px;">
            <button id="authBtn" class="icon-btn" style="width: 100%; background: var(--tg-primary); color: white; border-radius: 30px; padding: 14px; font-size: 1rem;">–í–æ–π—Ç–∏</button>
            <button id="switchAuthBtn" style="margin-top: 20px; background: none; border: none; color: var(--tg-primary); cursor: pointer;">–£ –º–µ–Ω—è –Ω–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞</button>
        </div>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ -->
    <div id="appContainer" style="display: none;">
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>MuzaffR</h2>
                <div class="header-actions">
                    <button class="icon-btn" id="newChatBtn" title="–ù–æ–≤—ã–π —á–∞—Ç"><i class="fas fa-edit"></i></button>
                    <button class="icon-btn" id="menuBtn" title="–ú–µ–Ω—é"><i class="fas fa-bars"></i></button>
                </div>
            </div>
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫...">
            </div>
            <div id="userList" class="user-list"></div>
        </div>

        <div class="chat-area">
            <div class="chat-header">
                <div class="chat-header-left">
                    <div class="chat-header-avatar" id="chatUserAvatar">U</div>
                    <div class="chat-header-info">
                        <h3 id="chatUserName">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</h3>
                        <span id="chatUserStatus"><span class="status-dot offline"></span> offline</span>
                    </div>
                </div>
                <div class="chat-header-actions">
                    <button class="icon-btn" id="searchChatBtn"><i class="fas fa-search"></i></button>
                    <button class="icon-btn" id="callBtn"><i class="fas fa-phone"></i></button>
                    <button class="icon-btn" id="profileBtn"><i class="fas fa-user"></i></button>
                </div>
            </div>

            <div id="messagesContainer" class="messages-container"></div>

            <!-- –°—Ç—Ä–æ–∫–∞ –æ—Ç–≤–µ—Ç–∞ -->
            <div id="replyPreview" class="reply-bar" style="display: none;">
                <span><span class="reply-author" id="replyAuthor"></span>: <span id="replyText"></span></span>
                <span class="reply-cancel" id="replyCancel"><i class="fas fa-times"></i></span>
            </div>

            <!-- –ü—Ä–µ–≤—å—é –≤–ª–æ–∂–µ–Ω–∏–π -->
            <div id="attachmentPreview" class="attachment-previews" style="display: none;"></div>

            <!-- –û–±–ª–∞—Å—Ç—å –≤–≤–æ–¥–∞ -->
            <div class="input-area">
                <div class="message-input-wrapper">
                    <textarea id="messageInput" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ" rows="1"></textarea>
                    <div class="input-actions">
                        <button class="icon-btn" id="attachBtn"><i class="fas fa-paperclip"></i></button>
                        <button class="icon-btn" id="emojiBtn"><i class="far fa-smile"></i></button>
                        <button class="icon-btn" id="giftBtn" title="–ü–æ–¥–∞—Ä–æ–∫"><i class="fas fa-gift"></i></button>
                        <button class="icon-btn" id="sendBtn" style="background: var(--tg-primary); color: white;"><i class="fas fa-paper-plane"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <input type="file" id="fileInput" style="display: none;" multiple>

    <!-- –≠–º–æ–¥–∑–∏-–ø–∏–∫–µ—Ä -->
    <div id="emojiPicker" class="emoji-picker">
        <div class="emoji-header">
            <span>–≠–º–æ–¥–∑–∏</span>
            <span class="reply-cancel" id="closeEmojiPicker"><i class="fas fa-times"></i></span>
        </div>
        <div class="emoji-categories">
            <span class="emoji-cat active" data-cat="smile">üòÄ</span>
            <span class="emoji-cat" data-cat="nature">üê∂</span>
            <span class="emoji-cat" data-cat="food">üçé</span>
            <span class="emoji-cat" data-cat="activity">‚öΩ</span>
        </div>
        <div id="emojiGrid" class="emoji-grid"></div>
    </div>

    <!-- –ü–∞–Ω–µ–ª—å –ø–æ–¥–∞—Ä–∫–æ–≤ -->
    <div id="giftPicker" class="gift-picker">
        <div class="emoji-header">
            <span>–ü–æ–¥–∞—Ä–∫–∏</span>
            <span class="reply-cancel" id="closeGiftPicker"><i class="fas fa-times"></i></span>
        </div>
        <div id="giftGrid" class="gift-grid"></div>
    </div>

    <!-- –ú–æ–¥–∞–ª–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è -->
    <div id="profileModal" class="modal">
        <div class="modal-content">
            <div class="avatar" style="width:80px; height:80px; margin:0 auto 20px; font-size:2rem;" id="profileAvatar">U</div>
            <h3 id="profileName">–ò–º—è</h3>
            <p id="profileStatus">—Å—Ç–∞—Ç—É—Å</p>
            <button class="icon-btn" style="margin-top:20px; background:var(--tg-primary); color:white;" id="closeProfile">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª–∫–∞ –Ω–æ–≤–æ–≥–æ —á–∞—Ç–∞ -->
    <div id="newChatModal" class="modal">
        <div class="modal-content">
            <h3>–ù–æ–≤—ã–π —á–∞—Ç</h3>
            <input type="text" id="newChatSearch" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" style="width:100%; padding:12px; border-radius:30px; border:1px solid var(--tg-border); background:var(--tg-bg); color:var(--tg-text); margin:15px 0;">
            <div id="newChatUserList" class="user-list" style="max-height:200px;"></div>
            <button class="icon-btn" id="closeNewChat" style="margin-top:15px;">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>

    <!-- –ö–Ω–æ–ø–∫–∞ —Ç–µ–º—ã -->
    <div class="theme-toggle" id="darkModeToggle"><i class="fas fa-moon"></i></div>

    <script type="module">
        // –ò–º–ø–æ—Ä—Ç—ã Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, push, onChildAdded, onValue, get, update, remove, onDisconnect } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        // –ö–æ–Ω—Ñ–∏–≥ Firebase (–≤–∞—à)
        const firebaseConfig = {
            apiKey: "AIzaSyCczUiqXKnCN7LDTv2zeSU7yzP3AO1N",
            authDomain: "doroschat.firebaseapp.com",
            databaseURL: "https://doroschat-default-rtdb.firebaseio.com/",
            projectId: "doroschat",
            storageBucket: "doroschat.appspot.com",
            messagingSenderId: "859595263053",
            appId: "1:859595263053:web:b536df40f4cefa02952004"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const storage = getStorage(app);

        // ---------- –°–û–°–¢–û–Ø–ù–ò–ï ----------
        let currentUser = null;
        let selectedUser = null;
        let chatId = null;
        let replyingTo = null;
        let attachments = [];
        let onlineStatus = {};
        let messagesListener = null;
        let typingTimeout = null;

        // ---------- –ü–û–î–ê–†–ö–ò ----------
        const gifts = [
            { id: 'cake', emoji: 'üéÇ', name: '–¢–æ—Ä—Ç–∏–∫', gif: 'https://i.giphy.com/media/3o7abAHdYvZdBNnGZq/giphy.gif' },
            { id: 'heart', emoji: '‚ù§Ô∏è', name: '–°–µ—Ä–¥–µ—á–∫–æ', gif: 'https://i.giphy.com/media/l0HlBO7eyXzSZkJri/giphy.gif' },
            { id: 'stars', emoji: '‚ú®', name: '–ó–≤—ë–∑–¥–æ—á–∫–∏', gif: 'https://i.giphy.com/media/3o7abB06u9bNzA8LC8/giphy.gif' },
            { id: 'cat', emoji: 'üê±', name: '–ö–æ—Ç–∏–∫', gif: 'https://i.giphy.com/media/JIX9t2j0ZTN9S/giphy.gif' },
            { id: 'fire', emoji: 'üî•', name: '–û–≥–æ–Ω—å', gif: 'https://i.giphy.com/media/l0MYt5jH6gkTWm8qo/giphy.gif' },
        ];

        // ---------- DOM –≠–õ–ï–ú–ï–ù–¢–´ ----------
        const authModal = document.getElementById('authModal');
        const appContainer = document.getElementById('appContainer');
        const authBtn = document.getElementById('authBtn');
        const switchAuthBtn = document.getElementById('switchAuthBtn');
        const usernameInp = document.getElementById('username');
        const passwordInp = document.getElementById('password');
        const authError = document.getElementById('authError');
        const userListDiv = document.getElementById('userList');
        const searchInput = document.getElementById('searchInput');
        const messagesContainer = document.getElementById('messagesContainer');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const chatUserName = document.getElementById('chatUserName');
        const chatUserStatus = document.getElementById('chatUserStatus');
        const chatUserAvatar = document.getElementById('chatUserAvatar');
        const attachBtn = document.getElementById('attachBtn');
        const fileInput = document.getElementById('fileInput');
        const attachmentPreview = document.getElementById('attachmentPreview');
        const emojiBtn = document.getElementById('emojiBtn');
        const emojiPicker = document.getElementById('emojiPicker');
        const closeEmojiPicker = document.getElementById('closeEmojiPicker');
        const giftBtn = document.getElementById('giftBtn');
        const giftPicker = document.getElementById('giftPicker');
        const closeGiftPicker = document.getElementById('closeGiftPicker');
        const giftGrid = document.getElementById('giftGrid');
        const replyPreview = document.getElementById('replyPreview');
        const replyAuthor = document.getElementById('replyAuthor');
        const replyText = document.getElementById('replyText');
        const replyCancel = document.getElementById('replyCancel');
        const darkModeToggle = document.getElementById('darkModeToggle');
        const profileBtn = document.getElementById('profileBtn');
        const profileModal = document.getElementById('profileModal');
        const profileAvatar = document.getElementById('profileAvatar');
        const profileName = document.getElementById('profileName');
        const profileStatus = document.getElementById('profileStatus');
        const closeProfile = document.getElementById('closeProfile');
        const menuBtn = document.getElementById('menuBtn');
        const sidebar = document.querySelector('.sidebar');
        const newChatBtn = document.getElementById('newChatBtn');
        const newChatModal = document.getElementById('newChatModal');
        const newChatSearch = document.getElementById('newChatSearch');
        const newChatUserList = document.getElementById('newChatUserList');
        const closeNewChat = document.getElementById('closeNewChat');
        const callBtn = document.getElementById('callBtn');
        const searchChatBtn = document.getElementById('searchChatBtn');

        // ---------- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ----------
        (function init() {
            setupEventListeners();
            checkAuthState();
            loadEmojis();
            loadTheme();
            renderGifts();
        })();

        function setupEventListeners() {
            authBtn.addEventListener('click', handleAuth);
            switchAuthBtn.addEventListener('click', toggleAuthMode);
            usernameInp.addEventListener('keypress', e => e.key==='Enter' && handleAuth());
            passwordInp.addEventListener('keypress', e => e.key==='Enter' && handleAuth());

            searchInput.addEventListener('input', filterChats);
            messageInput.addEventListener('input', handleTyping);
            messageInput.addEventListener('keypress', e => { if(e.key==='Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } });
            sendBtn.addEventListener('click', sendMessage);

            attachBtn.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', handleFileUpload);

            emojiBtn.addEventListener('click', () => emojiPicker.classList.toggle('show'));
            closeEmojiPicker.addEventListener('click', () => emojiPicker.classList.remove('show'));

            giftBtn.addEventListener('click', () => giftPicker.classList.toggle('show'));
            closeGiftPicker.addEventListener('click', () => giftPicker.classList.remove('show'));

            replyCancel.addEventListener('click', cancelReply);

            darkModeToggle.addEventListener('click', toggleDarkMode);
            profileBtn.addEventListener('click', showProfile);
            closeProfile.addEventListener('click', () => profileModal.classList.remove('show'));

            menuBtn.addEventListener('click', () => sidebar.classList.toggle('mobile-show'));

            newChatBtn.addEventListener('click', openNewChatModal);
            closeNewChat.addEventListener('click', () => newChatModal.classList.remove('show'));
            newChatSearch.addEventListener('input', searchNewChat);

            callBtn.addEventListener('click', () => showNotification('–ó–≤–æ–Ω–∫–∏ –ø–æ–∫–∞ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è'));
            searchChatBtn.addEventListener('click', () => showNotification('–ü–æ–∏—Å–∫ –ø–æ —á–∞—Ç—É –±—É–¥–µ—Ç –ø–æ–∑–∂–µ'));

            document.querySelectorAll('.emoji-cat').forEach(cat => {
                cat.addEventListener('click', () => {
                    document.querySelectorAll('.emoji-cat').forEach(c => c.classList.remove('active'));
                    cat.classList.add('active');
                    loadEmojis(cat.dataset.cat);
                });
            });

            document.getElementById('emojiGrid').addEventListener('click', e => {
                if(e.target.classList.contains('emoji-item')) insertEmoji(e.target.textContent);
            });

            document.addEventListener('click', (e) => {
                if (!giftPicker.contains(e.target) && e.target !== giftBtn) giftPicker.classList.remove('show');
                if (!emojiPicker.contains(e.target) && e.target !== emojiBtn) emojiPicker.classList.remove('show');
            });

            messageInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = this.scrollHeight + 'px';
            });
        }

        // ---------- –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø ----------
        function checkAuthState() {
            const saved = localStorage.getItem('muzaffr_user');
            if(saved) {
                currentUser = saved;
                afterLogin();
            } else {
                authModal.classList.add('show');
            }
        }

        function handleAuth() {
            const username = usernameInp.value.trim();
            const password = passwordInp.value.trim();
            if(!username || !password) return showAuthError('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è');

            if(authBtn.textContent === '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è') {
                get(ref(db, `users/${username}`)).then(snap => {
                    if(snap.exists()) showAuthError('–ò–º—è –∑–∞–Ω—è—Ç–æ');
                    else {
                        set(ref(db, `users/${username}`), { password, createdAt: Date.now(), lastSeen: Date.now(), status: 'online' })
                        .then(() => loginUser(username, password));
                    }
                });
            } else {
                loginUser(username, password);
            }
        }

        function loginUser(username, password) {
            get(ref(db, `users/${username}`)).then(snap => {
                if(!snap.exists()) return showAuthError('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');
                if(snap.val().password !== password) return showAuthError('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å');
                currentUser = username;
                localStorage.setItem('muzaffr_user', username);
                update(ref(db, `users/${username}`), { status:'online', lastSeen: Date.now() });
                afterLogin();
            });
        }

        function afterLogin() {
            authModal.classList.remove('show');
            appContainer.style.display = 'flex';
            chatUserAvatar.textContent = currentUser[0].toUpperCase();
            loadUserList();
            setupPresence();
            showNotification(`–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${currentUser}!`);
        }

        function showAuthError(msg) {
            authError.textContent = msg;
            authError.style.display = 'block';
            setTimeout(() => authError.style.display = 'none', 3000);
        }

        function toggleAuthMode() {
            authBtn.textContent = authBtn.textContent === '–í–æ–π—Ç–∏' ? '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è' : '–í–æ–π—Ç–∏';
            switchAuthBtn.textContent = authBtn.textContent === '–í–æ–π—Ç–∏' ? '–£ –º–µ–Ω—è –Ω–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞' : '–£ –º–µ–Ω—è –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç';
        }

        // ---------- –°–ü–ò–°–û–ö –ß–ê–¢–û–í ----------
        function loadUserList() {
            onValue(ref(db, `users/${currentUser}/chats`), async (snapshot) => {
                userListDiv.innerHTML = '';
                const chats = snapshot.val() || {};
                const usersSnap = await get(ref(db, 'users'));
                const allUsers = usersSnap.val();

                const sorted = Object.entries(chats).sort((a,b) => (b[1].lastMessage?.timestamp || 0) - (a[1].lastMessage?.timestamp || 0));
                for(const [chat, data] of sorted) {
                    const other = chat.split('_').find(u => u !== currentUser);
                    if(allUsers[other]) {
                        const unread = await getUnreadCount(chat);
                        addUserToList(other, allUsers[other], data.lastMessage, unread);
                    }
                }
            });
        }

        async function getUnreadCount(chatId) {
            const snapshot = await get(ref(db, `chats/${chatId}/messages`));
            let count = 0;
            snapshot.forEach(child => {
                const msg = child.val();
                if(msg.sender !== currentUser && !msg.read) count++;
            });
            return count;
        }

        function addUserToList(username, userData, lastMsg = { text: '', timestamp: 0 }, unread = 0) {
            const div = document.createElement('div');
            div.className = 'user-item';
            div.innerHTML = `
                <div class="avatar ${userData.status === 'online' ? 'online' : ''}">${username[0].toUpperCase()}</div>
                <div class="user-info">
                    <div class="user-row">
                        <span class="user-name">${username}</span>
                        <span class="time-badge">${lastMsg.timestamp ? formatTime(lastMsg.timestamp) : ''}</span>
                    </div>
                    <div class="last-message">${lastMsg.text ? (lastMsg.text.length>20 ? lastMsg.text.substr(0,20)+'‚Ä¶' : lastMsg.text) : '–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π'}</div>
                </div>
                ${unread > 0 ? `<span class="unread-badge">${unread}</span>` : ''}
            `;
            div.addEventListener('click', () => {
                selectUser(username);
                document.querySelectorAll('.user-item').forEach(el => el.classList.remove('active'));
                div.classList.add('active');
                if(window.innerWidth <= 800) sidebar.classList.remove('mobile-show');
            });
            userListDiv.appendChild(div);
        }

        function filterChats() {
            const term = searchInput.value.toLowerCase();
            document.querySelectorAll('.user-item').forEach(item => {
                const name = item.querySelector('.user-name').textContent.toLowerCase();
                item.style.display = name.includes(term) ? 'flex' : 'none';
            });
        }

        // ---------- –ù–û–í–´–ô –ß–ê–¢ ----------
        function openNewChatModal() {
            newChatModal.classList.add('show');
            loadAllUsersForNewChat();
        }

        async function loadAllUsersForNewChat() {
            const usersSnap = await get(ref(db, 'users'));
            const users = [];
            usersSnap.forEach(child => { if(child.key !== currentUser) users.push({ name: child.key }); });
            renderNewChatList(users);
        }

        function renderNewChatList(users) {
            newChatUserList.innerHTML = '';
            users.forEach(u => {
                const div = document.createElement('div');
                div.className = 'user-item';
                div.innerHTML = `<div class="avatar">${u.name[0].toUpperCase()}</div><div class="user-info"><span class="user-name">${u.name}</span></div>`;
                div.addEventListener('click', () => startNewChat(u.name));
                newChatUserList.appendChild(div);
            });
        }

        function searchNewChat() {
            const term = newChatSearch.value.toLowerCase();
            get(ref(db, 'users')).then(snap => {
                const filtered = [];
                snap.forEach(child => {
                    if(child.key !== currentUser && child.key.toLowerCase().includes(term))
                        filtered.push({ name: child.key });
                });
                renderNewChatList(filtered);
            });
        }

        function startNewChat(username) {
            newChatModal.classList.remove('show');
            const newChatId = [currentUser, username].sort().join('_');
            update(ref(db), {
                [`users/${currentUser}/chats/${newChatId}`]: { lastMessage: { text: '', timestamp: Date.now() } },
                [`users/${username}/chats/${newChatId}`]: { lastMessage: { text: '', timestamp: Date.now() } }
            }).then(() => selectUser(username));
        }

        // ---------- –í–´–ë–û–† –ß–ê–¢–ê ----------
        function selectUser(username) {
            selectedUser = username;
            chatId = [currentUser, username].sort().join('_');
            chatUserName.textContent = username;
            chatUserAvatar.textContent = username[0].toUpperCase();
            updateUserStatusInHeader();

            if(messagesListener) messagesListener();
            messagesContainer.innerHTML = '';

            messagesListener = onChildAdded(ref(db, `chats/${chatId}/messages`), (snap) => {
                const msg = snap.val();
                addMessageToChat(msg, snap.key);
            });

            onValue(ref(db, `typing/${chatId}/${username}`), (snap) => {
                const typingDiv = document.getElementById('typingIndicator');
                if(snap.val()) {
                    if(!typingDiv) {
                        const div = document.createElement('div');
                        div.id = 'typingIndicator';
                        div.className = 'typing-indicator';
                        div.innerHTML = `${username} –ø–µ—á–∞—Ç–∞–µ—Ç <div class="typing-dots"><span></span><span></span><span></span></div>`;
                        messagesContainer.appendChild(div);
                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    }
                } else if(typingDiv) typingDiv.remove();
            });

            markMessagesAsRead();
        }

        function updateUserStatusInHeader() {
            if(onlineStatus[selectedUser] === 'online') {
                chatUserStatus.innerHTML = '<span class="status-dot online"></span> online';
                chatUserAvatar.classList.add('online');
            } else {
                chatUserStatus.innerHTML = '<span class="status-dot offline"></span> offline';
                chatUserAvatar.classList.remove('online');
            }
        }

        // ---------- –°–û–û–ë–©–ï–ù–ò–Ø ----------
        function addMessageToChat(msg, msgId) {
            const lastDateDiv = messagesContainer.lastElementChild;
            const msgDate = new Date(msg.timestamp).toDateString();
            if(!lastDateDiv || !lastDateDiv.classList.contains('date-separator') || lastDateDiv.dataset.date !== msgDate) {
                const sep = document.createElement('div');
                sep.className = 'date-separator';
                sep.dataset.date = msgDate;
                sep.innerHTML = `<span>${formatDate(msg.timestamp)}</span>`;
                messagesContainer.appendChild(sep);
            }

            const div = document.createElement('div');
            div.className = `message ${msg.sender === currentUser ? 'out' : 'in'}`;
            div.dataset.id = msgId;

            let html = '';
            if(msg.replyTo) {
                html += `<div class="reply-preview"><strong>${msg.replyTo.sender === currentUser ? '–í—ã' : msg.replyTo.sender}</strong>: ${msg.replyTo.text || 'üìé'}</div>`;
            }

            // –ü–æ–¥–∞—Ä–æ–∫
            if(msg.type === 'gift' && msg.gift) {
                html += `
                    <div class="gift-message">
                        <img src="${msg.gift.gif}" alt="${msg.gift.name}" onerror="this.src='https://via.placeholder.com/150?text=${msg.gift.emoji}'">
                        <div>üéÅ ${msg.gift.name}</div>
                    </div>
                `;
            } else {
                if(msg.text) {
                    const linkedText = msg.text.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" style="color: var(--tg-primary);">$1</a>');
                    html += `<div>${linkedText}</div>`;
                }
                if(msg.attachments) {
                    html += '<div class="attachments">';
                    msg.attachments.forEach(att => {
                        if(att.type.startsWith('image/'))
                            html += `<img src="${att.url}" onclick="window.open('${att.url}')">`;
                        else
                            html += `<div class="file-attach"><i class="fas fa-file"></i> ${att.name} (${formatFileSize(att.size)})</div>`;
                    });
                    html += '</div>';
                }
            }

            const check = msg.sender === currentUser ? `<span class="double-check ${msg.read ? 'read' : ''}">${msg.read ? '‚úì‚úì' : '‚úì'}</span>` : '';
            html += `<div class="message-footer">${formatTime(msg.timestamp)} ${check}</div>`;

            div.innerHTML = html;
            messagesContainer.appendChild(div);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function sendMessage() {
            const text = messageInput.value.trim();
            if(!text && attachments.length === 0) return;

            const newMsg = {
                sender: currentUser,
                timestamp: Date.now(),
                read: false
            };
            if(text) newMsg.text = text;
            if(replyingTo) {
                newMsg.replyTo = {
                    messageId: replyingTo.id,
                    sender: replyingTo.sender,
                    text: replyingTo.text
                };
            }
            if(attachments.length) newMsg.attachments = attachments;

            const msgRef = push(ref(db, `chats/${chatId}/messages`));
            set(msgRef, newMsg).then(() => {
                messageInput.value = '';
                messageInput.style.height = 'auto';
                attachments = [];
                attachmentPreview.style.display = 'none';
                attachmentPreview.innerHTML = '';
                cancelReply();

                const lastMsg = { text: text || 'üìé –í–ª–æ–∂–µ–Ω–∏–µ', timestamp: Date.now() };
                update(ref(db), {
                    [`users/${currentUser}/chats/${chatId}/lastMessage`]: lastMsg,
                    [`users/${selectedUser}/chats/${chatId}/lastMessage`]: lastMsg
                });
            });
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ–¥–∞—Ä–∫–∞
        function sendGift(gift) {
            if (!chatId) return showNotification('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç');

            const giftMessage = {
                sender: currentUser,
                timestamp: Date.now(),
                read: false,
                type: 'gift',
                gift: gift
            };

            const msgRef = push(ref(db, `chats/${chatId}/messages`));
            set(msgRef, giftMessage).then(() => {
                const lastMsg = { text: `üéÅ –ü–æ–¥–∞—Ä–æ–∫: ${gift.name}`, timestamp: Date.now() };
                update(ref(db), {
                    [`users/${currentUser}/chats/${chatId}/lastMessage`]: lastMsg,
                    [`users/${selectedUser}/chats/${chatId}/lastMessage`]: lastMsg
                });
            });
        }

        function markMessagesAsRead() {
            if(!chatId) return;
            get(ref(db, `chats/${chatId}/messages`)).then(snap => {
                const updates = {};
                snap.forEach(child => {
                    const msg = child.val();
                    if(msg.sender !== currentUser && !msg.read) {
                        updates[`chats/${chatId}/messages/${child.key}/read`] = true;
                    }
                });
                if(Object.keys(updates).length) update(ref(db), updates).then(() => loadUserList());
            });
        }

        function handleTyping() {
            if(!chatId) return;
            set(ref(db, `typing/${chatId}/${currentUser}`), true);
            if(typingTimeout) clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => remove(ref(db, `typing/${chatId}/${currentUser}`)), 2000);
        }

        // ---------- –§–ê–ô–õ–´ ----------
        function handleFileUpload(e) {
            const files = Array.from(e.target.files);
            files.forEach(file => {
                if(file.size > 10*1024*1024) return alert('–§–∞–π–ª >10MB');
                const reader = new FileReader();
                reader.onload = (ev) => {
                    const item = document.createElement('div');
                    item.className = 'attach-preview-item';
                    item.innerHTML = file.type.startsWith('image/')
                        ? `<img src="${ev.target.result}"><span class="remove" data-name="${file.name}">√ó</span>`
                        : `<div style="padding:10px;"><i class="fas fa-file"></i><span class="remove" data-name="${file.name}">√ó</span></div>`;
                    attachmentPreview.appendChild(item);
                    attachmentPreview.style.display = 'flex';
                    item.querySelector('.remove').addEventListener('click', () => {
                        removeAttachment(file.name);
                        item.remove();
                        if(attachmentPreview.children.length===0) attachmentPreview.style.display='none';
                    });

                    const fileRef = storageRef(storage, `attachments/${currentUser}/${Date.now()}_${file.name}`);
                    uploadBytes(fileRef, file).then(snap => getDownloadURL(snap.ref)).then(url => {
                        attachments.push({ name:file.name, type:file.type, size:file.size, url });
                    });
                };
                if(file.type.startsWith('image/')) reader.readAsDataURL(file);
                else reader.readAsArrayBuffer(file);
            });
            fileInput.value = '';
        }

        function removeAttachment(name) {
            attachments = attachments.filter(a => a.name !== name);
        }

        // ---------- –ü–û–î–ê–†–ö–ò ----------
        function renderGifts() {
            giftGrid.innerHTML = gifts.map(g => `
                <div class="gift-item" data-id="${g.id}" data-emoji="${g.emoji}" data-gif="${g.gif}" data-name="${g.name}">
                    <img src="${g.gif}" alt="${g.name}" onerror="this.src='https://via.placeholder.com/60?text=${g.emoji}'">
                    <span>${g.name}</span>
                </div>
            `).join('');
            document.querySelectorAll('.gift-item').forEach(item => {
                item.addEventListener('click', () => {
                    const gift = {
                        id: item.dataset.id,
                        emoji: item.dataset.emoji,
                        gif: item.dataset.gif,
                        name: item.dataset.name
                    };
                    sendGift(gift);
                    giftPicker.classList.remove('show');
                });
            });
        }

        // ---------- –û–¢–í–ï–¢ ----------
        function cancelReply() {
            replyingTo = null;
            replyPreview.style.display = 'none';
        }

        // ---------- –≠–ú–û–î–ó–ò ----------
        const emojiLibrary = {
            smile: ['üòÄ','üòÉ','üòÑ','üòÅ','üòÜ','üòÖ','üòÇ','ü§£','üòä','üòá','üôÇ','üôÉ','üòâ','üòå','üòç','ü•∞','üòò','üòó','üòô','üòö','üòã','üòõ','üòù','üòú'],
            nature: ['üê∂','üê±','üê≠','üêπ','üê∞','ü¶ä','üêª','üêº','üê®','üêØ','ü¶Å','üêÆ','üê∑','üê∏','üêµ','ü¶Ñ','üêî','üêß','üê¶','üê§','ü¶Ü','ü¶Ö','ü¶â','üê∫'],
            food: ['üçé','üçê','üçä','üçã','üçå','üçâ','üçá','üçì','ü´ê','üçà','üçí','üçë','ü•≠','üçç','ü••','ü•ù','üçÖ','üçÜ','ü•ë','ü•¶','ü•í','üåΩ','ü•ï','üßÑ'],
            activity: ['‚öΩ','üèÄ','üèà','‚öæ','ü•é','üéæ','üèê','üèâ','ü•è','üé±','üèì','üè∏','üèí','üèë','ü•ç','üèè','ü™É','ü•Ö','‚õ≥','üèπ'],
        };

        function loadEmojis(cat='smile') {
            const grid = document.getElementById('emojiGrid');
            grid.innerHTML = emojiLibrary[cat].map(e => `<div class="emoji-item">${e}</div>`).join('');
        }

        function insertEmoji(emoji) {
            messageInput.value += emoji;
            messageInput.focus();
        }

        // ---------- –ü–†–ò–°–£–¢–°–¢–í–ò–ï ----------
        function setupPresence() {
            update(ref(db, `users/${currentUser}`), { status:'online', lastSeen:Date.now() });
            onDisconnect(ref(db, `users/${currentUser}`)).update({ status:'offline', lastSeen:Date.now() });

            onValue(ref(db, 'users'), (snap) => {
                const users = snap.val();
                onlineStatus = {};
                for(let u in users) if(u !== currentUser) onlineStatus[u] = users[u].status;
                if(selectedUser) updateUserStatusInHeader();
                document.querySelectorAll('.user-item .avatar').forEach(av => {
                    const name = av.parentElement.querySelector('.user-name').textContent;
                    if(onlineStatus[name] === 'online') av.classList.add('online');
                    else av.classList.remove('online');
                });
            });
        }

        // ---------- –ü–†–û–§–ò–õ–¨ ----------
        function showProfile() {
            if(!selectedUser) return showNotification('–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç');
            profileAvatar.textContent = selectedUser[0].toUpperCase();
            profileName.textContent = selectedUser;
            profileStatus.textContent = onlineStatus[selectedUser] === 'online' ? '–≤ —Å–µ—Ç–∏' : '–±—ã–ª(–∞) –Ω–µ–¥–∞–≤–Ω–æ';
            profileModal.classList.add('show');
        }

        // ---------- –¢–ï–ú–ê ----------
        function loadTheme() {
            if(localStorage.getItem('darkMode') === 'true') {
                document.body.classList.add('dark-mode');
                darkModeToggle.innerHTML = '<i class="fas fa-sun"></i>';
            }
        }
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            darkModeToggle.innerHTML = isDark ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
            localStorage.setItem('darkMode', isDark);
        }

        // ---------- –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø ----------
        function showNotification(msg) {
            const n = document.createElement('div');
            n.className = 'notification';
            n.textContent = msg;
            document.body.appendChild(n);
            setTimeout(() => n.remove(), 3000);
        }

        // ---------- –£–¢–ò–õ–ò–¢–´ ----------
        function formatTime(ts) {
            if(!ts) return '';
            return new Date(ts).toLocaleTimeString('ru', { hour:'2-digit', minute:'2-digit' });
        }
        function formatDate(ts) {
            const d = new Date(ts);
            const today = new Date();
            if(d.toDateString() === today.toDateString()) return '–°–µ–≥–æ–¥–Ω—è';
            const yest = new Date(today.setDate(today.getDate()-1));
            if(d.toDateString() === yest.toDateString()) return '–í—á–µ—Ä–∞';
            return d.toLocaleDateString('ru', { day:'numeric', month:'long' });
        }
        function formatFileSize(bytes) {
            if(bytes<1024) return bytes+' B';
            if(bytes<1024*1024) return (bytes/1024).toFixed(1)+' KB';
            return (bytes/(1024*1024)).toFixed(1)+' MB';
        }
    </script>
</body>
</html>
